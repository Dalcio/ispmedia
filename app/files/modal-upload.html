<div class="modal glass-strong">
    <div class="modal-header">
        <h2 class="modal-title">Upload de Ficheiros</h2>
        <button class="modal-close" onclick="Functions.closeModal('modal-upload')">&times;</button>
    </div>
    <div class="modal-body">
        <div class="upload-container">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </div>
                <div class="upload-text">
                    <h3>Arraste ficheiros aqui</h3>
                    <p>ou clique para selecionar ficheiros</p>
                </div>
                <input type="file" id="file-input" multiple accept="image/*,video/*,audio/*,.pdf,.txt,.doc,.docx,.xls,.xlsx">
            </div>
            
            <div class="upload-info">
                <div class="info-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <span>Tamanho máximo: 100MB por ficheiro</span>
                </div>
                <div class="info-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                    <span>Formatos suportados: JPG, PNG, PDF, MP4, MP3, TXT, DOC, XLS</span>
                </div>
            </div>
        </div>
        
        <div class="upload-queue" id="upload-queue">
            <!-- Ficheiros serão adicionados aqui -->
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="Functions.closeModal('modal-upload')">Cancelar</button>
        <button class="btn btn-primary" onclick="startUpload()" id="upload-btn" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Enviar Ficheiros
        </button>
    </div>
</div>

<script>
let selectedFiles = [];
let isUploading = false;

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    
    // Eventos do upload area
    uploadArea.addEventListener('click', () => {
        if (!isUploading) {
            fileInput.click();
        }
    });
    
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
    
    // Evento de seleção de ficheiros
    fileInput.addEventListener('change', handleFileSelect);
});

function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    
    if (!isUploading) {
        document.getElementById('upload-area').classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    
    document.getElementById('upload-area').classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    
    document.getElementById('upload-area').classList.remove('drag-over');
    
    if (!isUploading) {
        const files = Array.from(e.dataTransfer.files);
        processFiles(files);
    }
}

function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    processFiles(files);
}

function processFiles(files) {
    const validFiles = [];
    
    files.forEach(file => {
        const errors = Functions.validateFile(file);
        
        if (errors.length === 0) {
            validFiles.push(file);
        } else {
            Functions.renderAlert('error', `${file.name}: ${errors.join(', ')}`);
        }
    });
    
    if (validFiles.length > 0) {
        addFilesToQueue(validFiles);
    }
}

function addFilesToQueue(files) {
    const queue = document.getElementById('upload-queue');
    
    files.forEach(file => {
        // Verifica se o ficheiro já foi adicionado
        const existingFile = selectedFiles.find(f => f.name === file.name && f.size === file.size);
        if (existingFile) {
            Functions.renderAlert('warning', `${file.name} já foi adicionado`);
            return;
        }
        
        selectedFiles.push(file);
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-queue-item';
        fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">
                    ${getFileIcon(file.type)}
                </div>
                <div class="file-details">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${Functions.formatFileSize(file.size)}</div>
                </div>
            </div>
            <div class="file-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">0%</div>
            </div>
            <div class="file-actions">
                <button class="btn btn-ghost btn-sm" onclick="removeFile('${file.name}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        `;
        
        queue.appendChild(fileItem);
    });
    
    updateUploadButton();
}

function getFileIcon(type) {
    if (type.startsWith('image/')) {
        return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21,15 16,10 5,21"/>
        </svg>`;
    } else if (type.startsWith('video/')) {
        return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="23,7 16,12 23,17"/>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
        </svg>`;
    } else if (type.startsWith('audio/')) {
        return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18V5l12-2v13"/>
            <circle cx="6" cy="18" r="3"/>
            <circle cx="18" cy="16" r="3"/>
        </svg>`;
    } else {
        return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>`;
    }
}

function removeFile(fileName) {
    selectedFiles = selectedFiles.filter(file => file.name !== fileName);
    
    const queue = document.getElementById('upload-queue');
    const fileItems = queue.querySelectorAll('.file-queue-item');
    
    fileItems.forEach(item => {
        const nameElement = item.querySelector('.file-name');
        if (nameElement.textContent === fileName) {
            item.remove();
        }
    });
    
    updateUploadButton();
}

function updateUploadButton() {
    const uploadBtn = document.getElementById('upload-btn');
    const hasFiles = selectedFiles.length > 0;
    
    uploadBtn.disabled = !hasFiles || isUploading;
    uploadBtn.textContent = hasFiles ? 
        `Enviar ${selectedFiles.length} ficheiro${selectedFiles.length > 1 ? 's' : ''}` : 
        'Enviar Ficheiros';
}

function startUpload() {
    if (selectedFiles.length === 0 || isUploading) return;
    
    isUploading = true;
    updateUploadButton();
    
    const uploadBtn = document.getElementById('upload-btn');
    uploadBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Enviando...
    `;
    
    // Simula upload de cada ficheiro
    const uploadPromises = selectedFiles.map((file, index) => {
        return simulateFileUpload(file, index);
    });
    
    Promise.all(uploadPromises).then(() => {
        Functions.renderAlert('success', `${selectedFiles.length} ficheiro(s) enviado(s) com sucesso!`);
        
        setTimeout(() => {
            Functions.closeModal('modal-upload');
            resetUploadModal();
        }, 1000);
    }).catch(error => {
        Functions.renderAlert('error', 'Erro durante o upload. Tente novamente.');
        isUploading = false;
        updateUploadButton();
    });
}

function simulateFileUpload(file, index) {
    return new Promise((resolve) => {
        const fileItems = document.querySelectorAll('.file-queue-item');
        const fileItem = fileItems[index];
        const progressFill = fileItem.querySelector('.progress-fill');
        const progressText = fileItem.querySelector('.progress-text');
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 10;
            
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                resolve();
            }
            
            progressFill.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
            
            if (progress === 100) {
                progressText.textContent = 'Concluído';
                progressFill.style.background = '#28a745';
            }
        }, 100);
    });
}

function resetUploadModal() {
    selectedFiles = [];
    isUploading = false;
    
    document.getElementById('upload-queue').innerHTML = '';
    document.getElementById('file-input').value = '';
    
    const uploadBtn = document.getElementById('upload-btn');
    uploadBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7,10 12,15 17,10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Enviar Ficheiros
    `;
    
    updateUploadButton();
}
</script>

<style>
.upload-container {
    margin-bottom: var(--spacing-xl);
}

.upload-area {
    border: 2px dashed var(--border-light);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-xxl);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-medium);
    position: relative;
    margin-bottom: var(--spacing-lg);
}

.upload-area:hover {
    border-color: var(--primary-blue);
    background: var(--soft-blue);
}

.upload-area.drag-over {
    border-color: var(--primary-blue);
    background: var(--soft-blue);
    transform: scale(1.02);
}

.upload-icon {
    margin-bottom: var(--spacing-lg);
    color: var(--primary-blue);
}

.upload-text h3 {
    margin-bottom: var(--spacing-sm);
    color: var(--text-primary);
}

.upload-text p {
    color: var(--text-secondary);
    margin: 0;
}

.upload-area input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.upload-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.info-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.info-item svg {
    color: var(--primary-blue);
}

.upload-queue {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-md);
    background: var(--light-gray);
    padding: var(--spacing-md);
}

.upload-queue:empty {
    display: none;
}

.file-queue-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--white);
    border-radius: var(--border-radius-sm);
    margin-bottom: var(--spacing-sm);
    border: 1px solid var(--border-light);
}

.file-queue-item:last-child {
    margin-bottom: 0;
}

.file-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex: 1;
}

.file-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius-sm);
    background: var(--soft-blue);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-blue);
}

.file-details {
    flex: 1;
}

.file-name {
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
    word-break: break-word;
}

.file-size {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.file-progress {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    min-width: 120px;
}

.progress-bar {
    width: 80px;
    height: 6px;
    background: var(--border-light);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--primary-blue);
    transition: width var(--transition-fast);
}

.progress-text {
    font-size: 0.875rem;
    color: var(--text-secondary);
    min-width: 40px;
    text-align: right;
}

.file-actions {
    display: flex;
    gap: var(--spacing-xs);
}

/* Responsividade */
@media (max-width: 768px) {
    .upload-area {
        padding: var(--spacing-xl);
    }
    
    .file-queue-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
    }
    
    .file-info {
        width: 100%;
    }
    
    .file-progress {
        width: 100%;
        justify-content: space-between;
    }
    
    .progress-bar {
        flex: 1;
        margin-right: var(--spacing-sm);
    }
}

@media (max-width: 480px) {
    .upload-info {
        gap: var(--spacing-md);
    }
    
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-xs);
    }
    
    .modal-footer {
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    
    .modal-footer .btn {
        width: 100%;
    }
}
</style>
