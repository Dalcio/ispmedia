<div class="login-page fade-in">
  <div class="container">
    <div class="row justify-content-center min-vh-100 align-items-center">
      <div class="col-lg-5 col-md-7">
        <div class="login-card glass-card p-5">
          <!-- Header -->
          <div class="text-center mb-5">
            <div class="login-logo mb-3">
              <i
                class="bi bi-play-circle-fill text-primary"
                style="font-size: 4rem"
              ></i>
            </div>
            <h2 class="login-title text-gradient">Bem-vindo de volta</h2>
            <p class="login-subtitle text-muted">
              Faça login para acessar sua conta ISPMedia
            </p>
          </div>

          <!-- Login Form -->
          <form id="loginForm" data-form-type="login" novalidate>
            <div class="mb-4">
              <div class="form-floating">
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  placeholder="seu@email.com"
                  required
                />
                <label for="email">
                  <i class="bi bi-envelope me-2"></i>
                  Email
                </label>
              </div>
              <div class="invalid-feedback">
                Por favor, insira um email válido.
              </div>
            </div>

            <div class="mb-4">
              <div class="form-floating">
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  name="password"
                  placeholder="Senha"
                  required
                />
                <label for="password">
                  <i class="bi bi-lock me-2"></i>
                  Senha
                </label>
              </div>
              <div class="invalid-feedback">Por favor, insira sua senha.</div>
            </div>

            <div class="row mb-4">
              <div class="col-6">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="remember"
                    name="remember"
                  />
                  <label class="form-check-label" for="remember">
                    Lembrar-me
                  </label>
                </div>
              </div>
              <div class="col-6 text-end">
                <a
                  href="#"
                  class="text-decoration-none"
                  data-bs-toggle="modal"
                  data-bs-target="#forgotPasswordModal"
                >
                  Esqueceu a senha?
                </a>
              </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 btn-lg mb-3">
              <i class="bi bi-box-arrow-in-right me-2"></i>
              Entrar
            </button>

            <div class="text-center">
              <p class="text-muted">
                Não tem uma conta?
                <a
                  href="#"
                  class="text-decoration-none"
                  data-bs-toggle="modal"
                  data-bs-target="#registerModal"
                >
                  Cadastre-se
                </a>
              </p>
            </div>
          </form>

          <!-- Demo Accounts -->
          <div class="demo-accounts mt-4 pt-4 border-top">
            <h6 class="text-center text-muted mb-3">Contas de Demonstração</h6>
            <div class="row">
              <div class="col-6">
                <button
                  type="button"
                  class="btn btn-outline-primary w-100 btn-sm"
                  onclick="fillDemoAdmin()"
                >
                  <i class="bi bi-person-fill-gear me-1"></i>
                  Admin
                </button>
              </div>
              <div class="col-6">
                <button
                  type="button"
                  class="btn btn-outline-secondary w-100 btn-sm"
                  onclick="fillDemoUser()"
                >
                  <i class="bi bi-person-fill me-1"></i>
                  Usuário
                </button>
              </div>
            </div>
            <p class="text-center text-muted mt-2">
              <small
                >Use as contas de demonstração para testar a aplicação</small
              >
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Forgot Password Modal -->
<div
  class="modal fade"
  id="forgotPasswordModal"
  tabindex="-1"
  aria-labelledby="forgotPasswordModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="forgotPasswordModalLabel">
          <i class="bi bi-key me-2"></i>
          Recuperar Senha
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="forgotPasswordForm">
          <div class="mb-3">
            <p class="text-muted">
              Digite seu email para receber instruções de recuperação de senha.
            </p>
          </div>
          <div class="mb-3">
            <div class="form-floating">
              <input
                type="email"
                class="form-control"
                id="forgotEmail"
                placeholder="seu@email.com"
                required
              />
              <label for="forgotEmail">
                <i class="bi bi-envelope me-2"></i>
                Email
              </label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-send me-2"></i>
            Enviar Instruções
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Register Modal -->
<div
  class="modal fade"
  id="registerModal"
  tabindex="-1"
  aria-labelledby="registerModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="registerModalLabel">
          <i class="bi bi-person-plus me-2"></i>
          Criar Conta
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="registerForm">
          <div class="mb-3">
            <div class="form-floating">
              <input
                type="text"
                class="form-control"
                id="registerName"
                placeholder="Nome completo"
                required
              />
              <label for="registerName">
                <i class="bi bi-person me-2"></i>
                Nome completo
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-floating">
              <input
                type="email"
                class="form-control"
                id="registerEmail"
                placeholder="seu@email.com"
                required
              />
              <label for="registerEmail">
                <i class="bi bi-envelope me-2"></i>
                Email
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-floating">
              <input
                type="password"
                class="form-control"
                id="registerPassword"
                placeholder="Senha"
                required
              />
              <label for="registerPassword">
                <i class="bi bi-lock me-2"></i>
                Senha
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-floating">
              <input
                type="password"
                class="form-control"
                id="registerConfirmPassword"
                placeholder="Confirmar senha"
                required
              />
              <label for="registerConfirmPassword">
                <i class="bi bi-lock-fill me-2"></i>
                Confirmar senha
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="agreeTerms"
                required
              />
              <label class="form-check-label" for="agreeTerms">
                Concordo com os
                <a href="#" class="text-decoration-none">Termos de Uso</a> e
                <a href="#" class="text-decoration-none"
                  >Política de Privacidade</a
                >
              </label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-person-plus me-2"></i>
            Criar Conta
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Inicializar página de login
  document.addEventListener("DOMContentLoaded", function () {
    initializeLoginPage();
  });

  function initializeLoginPage() {
    // Verificar se já está logado
    if (window.Session && window.Session.isAuthenticated()) {
      if (window.Router) {
        window.Router.navigateToRoute("home");
      }
      return;
    }

    // Configurar formulários
    setupLoginForm();
    setupForgotPasswordForm();
    setupRegisterForm();

    // Configurar validação
    setupFormValidation();

    // Log da visita
    if (window.logger) {
      window.logger.userEvent("login_page_visited");
    }
  }

  function setupLoginForm() {
    const loginForm = document.getElementById("loginForm");

    if (loginForm) {
      loginForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!this.checkValidity()) {
          e.stopPropagation();
          this.classList.add("was-validated");
          return;
        }

        const formData = new FormData(this);
        const credentials = {
          email: formData.get("email"),
          password: formData.get("password"),
        };
        const rememberMe = formData.get("remember") === "on";

        await handleLogin(credentials, rememberMe);
      });
    }
  }

  function setupForgotPasswordForm() {
    const forgotPasswordForm = document.getElementById("forgotPasswordForm");

    if (forgotPasswordForm) {
      forgotPasswordForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const email = document.getElementById("forgotEmail").value;
        await handleForgotPassword(email);
      });
    }
  }

  function setupRegisterForm() {
    const registerForm = document.getElementById("registerForm");

    if (registerForm) {
      registerForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!this.checkValidity()) {
          e.stopPropagation();
          this.classList.add("was-validated");
          return;
        }

        const formData = new FormData(this);
        const userData = {
          name: formData.get("name"),
          email: formData.get("email"),
          password: formData.get("password"),
          confirmPassword: formData.get("confirmPassword"),
        };

        await handleRegister(userData);
      });
    }
  }

  function setupFormValidation() {
    // Validação personalizada para confirmação de senha
    const registerPassword = document.getElementById("registerPassword");
    const registerConfirmPassword = document.getElementById(
      "registerConfirmPassword"
    );

    if (registerPassword && registerConfirmPassword) {
      registerConfirmPassword.addEventListener("input", function () {
        if (this.value !== registerPassword.value) {
          this.setCustomValidity("As senhas não coincidem");
        } else {
          this.setCustomValidity("");
        }
      });
    }
  }

  async function handleLogin(credentials, rememberMe) {
    try {
      if (window.showLoader) window.showLoader();

      if (!window.Session) {
        throw new Error("Session manager não disponível");
      }

      const result = await window.Session.login(credentials, rememberMe);

      if (result.success) {
        if (window.renderAlert) {
          window.renderAlert(result.message, "success");
        }

        // Redirecionar para home após um breve delay
        setTimeout(() => {
          if (window.Router) {
            window.Router.navigateToRoute("home");
          }
        }, 1000);
      } else {
        if (window.renderAlert) {
          window.renderAlert(result.message, "error");
        }
      }
    } catch (error) {
      if (window.logger) {
        window.logger.exception(error, { context: "login_attempt" });
      }
      if (window.renderAlert) {
        window.renderAlert("Erro no login. Tente novamente.", "error");
      }
    } finally {
      if (window.hideLoader) window.hideLoader();
    }
  }

  async function handleForgotPassword(email) {
    try {
      if (window.showLoader) window.showLoader();

      // Simular envio de email
      await new Promise((resolve) => setTimeout(resolve, 1500));

      if (window.renderAlert) {
        window.renderAlert("Instruções enviadas para seu email!", "success");
      }

      // Fechar modal
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("forgotPasswordModal")
      );
      if (modal) {
        modal.hide();
      }
    } catch (error) {
      if (window.logger) {
        window.logger.exception(error, { context: "forgot_password" });
      }
      if (window.renderAlert) {
        window.renderAlert(
          "Erro ao enviar instruções. Tente novamente.",
          "error"
        );
      }
    } finally {
      if (window.hideLoader) window.hideLoader();
    }
  }

  async function handleRegister(userData) {
    try {
      if (window.showLoader) window.showLoader();

      // Validar senhas
      if (userData.password !== userData.confirmPassword) {
        throw new Error("As senhas não coincidem");
      }

      // Simular registro
      await new Promise((resolve) => setTimeout(resolve, 1500));

      if (window.renderAlert) {
        window.renderAlert(
          "Conta criada com sucesso! Verifique seu email.",
          "success"
        );
      }

      // Fechar modal
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("registerModal")
      );
      if (modal) {
        modal.hide();
      }
    } catch (error) {
      if (window.logger) {
        window.logger.exception(error, { context: "register_attempt" });
      }
      if (window.renderAlert) {
        window.renderAlert(
          error.message || "Erro ao criar conta. Tente novamente.",
          "error"
        );
      }
    } finally {
      if (window.hideLoader) window.hideLoader();
    }
  }

  // Funções para contas de demonstração
  function fillDemoAdmin() {
    document.getElementById("email").value = "admin@ispmedia.com";
    document.getElementById("password").value = "admin123";
    document.getElementById("remember").checked = true;

    if (window.renderAlert) {
      window.renderAlert(
        'Dados de admin preenchidos. Clique em "Entrar".',
        "info"
      );
    }
  }

  function fillDemoUser() {
    document.getElementById("email").value = "user@ispmedia.com";
    document.getElementById("password").value = "user123";
    document.getElementById("remember").checked = false;

    if (window.renderAlert) {
      window.renderAlert(
        'Dados de usuário preenchidos. Clique em "Entrar".',
        "info"
      );
    }
  }
</script>

<style>
  .login-card {
    max-width: 100%;
    border-radius: 24px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  }

  .login-logo {
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
    }
  }

  .login-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .login-subtitle {
    font-size: 1rem;
    margin-bottom: 0;
  }

  .demo-accounts {
    background: rgba(99, 102, 241, 0.05);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
  }

  .form-floating .form-control {
    border-radius: 12px;
  }

  .form-floating label {
    color: var(--gray);
  }

  .form-floating .form-control:focus + label {
    color: var(--primary-color);
  }

  .btn-lg {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    border-radius: 12px;
  }

  .modal-content {
    border-radius: 20px;
    border: none;
  }

  .modal-header {
    padding: 2rem 2rem 1rem;
  }

  .modal-body {
    padding: 1rem 2rem 2rem;
  }

  @media (max-width: 768px) {
    .login-card {
      margin: 1rem;
      padding: 2rem !important;
    }

    .login-title {
      font-size: 1.5rem;
    }

    .demo-accounts {
      padding: 1rem;
    }
  }
</style>
